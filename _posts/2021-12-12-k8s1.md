---
title: MINIO & VELERO install on K8S 
tag : [nft]
author: hayley
---

<font size="5" color="purple"><b>k8s 환경 내 MinIO & Velero 구축</b></font>
<p>- Kubernetes 환경에서 Backup 후 복원하는 방법 구축
<p>- Velero를 통해 백업 및 복원 기능을 제공할 수 있고 Velero에서 연동 가능한 스토리지로 MinIO가 있다.
<br>
<br>
<br><b>왜 Kubernetes 환경에서 Backup이 중요할까</b>
<p>Kubernetes 클러스터의 downtime은 비지니스적으로 financial impact가 있고 조직의 brand에 영향을 끼친다. 필요한 모든 에플리케이션으로 전체 클러스터를 설정하는 것은 쉬운 일이 아니며 클러스터를 다시 설정하고 작업 준비를 하는데 상당한 시간이 소요된다. 따라서 조직의 비지니스에 영향을 주지 않고 Kubernetes 클러스터의 disaster scenario에 신속하게 대비하기 위해 Backup이 중요하다.
<br>
<p><img src="https://github.com/hayleyshim/hayleyshim.github.io/blob/master/assets/images/projects/scenario.PNG?raw=true">  
<p><b>Scenario</b>
<br>
<br>  
<p><b>1. 사전 작업</b>
<p>개발 환경(Env : Debian 10 Server image, k8s 설치) 
<p>- OS : Debian 10 Server image : 상대적으로 서버의 안정성이 높고 의존성 있는 패키지들을 자동으로 알려주어 패키지의 업데이트가 용이한 데비안 리눅스 환경에 구축
<p>- 클러스터 만들기 (master / worker 노드)
<br>
<p>  1) docker install on debian 10 : <a href="https://docs.docker.com/engine/install/debian/#install-using-the-repository">https://docs.docker.com/engine/install/debian/#install-using-the-repository</a>
<p>  2) k8s install : <a href="https://www.hostafrica.co.za/blog/new-technologies/how-to-install-docker-on-linux-and-windows/#debian">https://www.hostafrica.co.za/blog/new-technologies/how-to-install-docker-on-linux-and-windows/#debian</a>
<pre><code>kubectl get node</code></pre> 
<p><img src="https://github.com/hayleyshim/hayleyshim.github.io/blob/master/assets/images/projects/k8s.PNG?raw=true">
<br>
<br>  
<p><b>2. minIO(master node 설치)</b>
<p>- minIO는 GNU Affero General Public License v3.0에 따라 출시된 고성능 개체 스토리지
<p>- Amazon S3 클라우드 스토리지 서비스와 호환되는 API
<br>
<br>
<p>1) minIO 설치 : <a href="https://docs.min.io/docs/minio-quickstart-guide.html">https://docs.min.io/docs/minio-quickstart-guide.html</a>
<pre><code>wget https://dl.min.io/server/minio/release/linux-arm64/minio
chmod +x minIO
./minio server /data </code></pre>
<p><img src="https://raw.githubusercontent.com/hayleyshim/hayleyshim.github.io/master/assets/images/projects/minio1.png">
<p><img src="https://raw.githubusercontent.com/hayleyshim/hayleyshim.github.io/master/assets/images/projects/minio2.png">  
<br> 
<br>  
<br>  
<p><b>3. Velero <a href="https://velero.io/docs/v1.7/">https://velero.io/docs/v1.7/</a> (master / worker 모두 설치)</b>
<p>- Velero는 Kubernetes 클러스터 리소스 및 영구 볼륨을 백업 및 복원하는 도구 제공
<p>- cloud provider 또는 on-premises에서 velero를 실행할 수 있다
<br>
<br>
<p>1) Velero를 설치한다 (두 클러스터에서 동일한 단계를 반복) : github 링크 에서 velero 설정의 최신 릴리스를 다운로드
<pre><code>curl -L https://github.com/vmware-tanzu/velero/releases/download/v1.7.0/velero-v1.7.0-linux-arm64.tar.gz | tar xvfz - </code></pre>
<pre><code>mv velero-v1.7.0-linux-arm64/velero /usr/local/bin  </code></pre>
<br>
<br> 
<pre><code>velero version 
velero version --client-only (worker node) </code></pre> 
<p><img src="https://raw.githubusercontent.com/hayleyshim/hayleyshim.github.io/master/assets/images/projects/velero1.png">    
<p><img src="https://raw.githubusercontent.com/hayleyshim/hayleyshim.github.io/master/assets/images/projects/velero2.png">    
<br>
<p>2) 아래 명령을 사용하여 velero install 명령을 실행 중인 마스터 컴퓨터의 일부 위치에 minio 자격 증명을 만든다. (이 경우에는 /root/credentials-velero에 만들었다 ) 
<pre><code>cat <<EOF>> /root/credentials-velero
[default]
aws_access_key_id=minioadmin 
aws_secret_access_key=minioadmin 
EOF </code></pre> 
<br> 
<pre><code>velero install --provider aws --plugins velero/velero-plugin-for-aws:v1.0.0 --bucket kubedemo --secret-file /root/credentials-velero --use-volume-snapshots=false --default-volumes-to-restic --backup-location-config region=minio,s3ForcePathStyle="true",s3Url=http://[minio server IP]:9000 --use-restic  </code></pre>
<p><img src="https://raw.githubusercontent.com/hayleyshim/hayleyshim.github.io/master/assets/images/projects/velero3.png"> 
<br>
<br> 
<p>3) 백업 및 복원
<pre><code>velero backup create myfirstbackup-bkp --include-namespaces my-namespace --wait </code></pre>
<pre><code>velero restore create myfirsrestore-rst --from-backup myfirstbackup-bkp --wait </code></pre>
<br>
<br> 
<p>4) 백업 및 복원 확인
<pre><code>velero backup get </code></pre>
<p><img src="https://raw.githubusercontent.com/hayleyshim/hayleyshim.github.io/master/assets/images/projects/velero4.png">      
<pre><code>velero restore get </code></pre>
<p><img src="https://raw.githubusercontent.com/hayleyshim/hayleyshim.github.io/master/assets/images/projects/velero5.png">   
  
<br> <font size="5" color="purple"><b>[Reference]
<p><a href="https://medium.com/@maheshd7878/restore-backup-migrate-kubernetes-cluster-with-velero-434fa151f1e8">https://medium.com/@maheshd7878/restore-backup-migrate-kubernetes-cluster-with-velero-434fa151f1e8  
<p><a href="https://www.debontonline.com/p/kubernetes.html">https://www.debontonline.com/p/kubernetes.html 
<p><a href="https://ichi.pro/ko/veleroleul-sayonghan-kubernetes-keulleoseuteo-maigeuleisyeon-146918669234861">https://ichi.pro/ko/veleroleul-sayonghan-kubernetes-keulleoseuteo-maigeuleisyeon-146918669234861  
<p><a href="https://teamsmiley.github.io/2020/10/10/kubernetes-backup-velero/">https://teamsmiley.github.io/2020/10/10/kubernetes-backup-velero/
<p><a href="http://egloos.zum.com/dreams402/v/2663455">http://egloos.zum.com/dreams402/v/2663455 
